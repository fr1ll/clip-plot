name: "Vendor Annoy wheel"

on:
  workflow_dispatch:
    inputs:
      annoy_ref:
        description: "Annoy ref to build (tag like v1.17.3 or commit SHA)"
        required: true
        type: string
      output_version:
        description: "Directory label for output (e.g., 2025.12.05 or your package version)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: vendor-annoy-env
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - name: Checkout (this repo)
        uses: actions/checkout@v4

      - name: Install system build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Clone spotify/annoy at ref
        run: |
          git clone --no-tags https://github.com/spotify/annoy.git annoy-src
          cd annoy-src
          # Try to fetch the ref if it's not a branch/tag name that's included by default
          git fetch origin "${{ inputs.annoy_ref }}" --depth=1 || true
          git checkout "${{ inputs.annoy_ref }}"
          git rev-parse --short HEAD

      - name: Ensure vendor output directory exists
        run: |
          mkdir -p "vendor/annoy/${{ inputs.output_version }}"

      - name: Build wheel only with uv (PEP 517)
        working-directory: annoy-src
        run: |
          # Build only the wheel for the selected Python, no sdist
          uv build --wheel --python ${{ matrix.python-version }} \
          --out_dir "../vendor/annoy/${{ inputs.output_version }}"
          ls -l "../vendor/annoy/${{ inputs.output_version }}"
    
