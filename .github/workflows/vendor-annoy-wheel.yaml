name: "Vendor Annoy wheel"

on:
  workflow_dispatch:
    inputs:
      annoy_ref:
        description: "Annoy ref to build (tag like v1.17.3 or commit SHA)"
        required: true
        type: string
      output_version:
        description: "Directory label for output (e.g., 2025.12.05 or your package version)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: vendor-annoy-env
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - name: Checkout (this repo)
        uses: actions/checkout@v4

      - name: Install system build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Clone spotify/annoy at ref
        run: |
          git clone --no-tags https://github.com/spotify/annoy.git annoy-src
          cd annoy-src
          # Try to fetch the ref if it's not a branch/tag name that's included by default
          git fetch origin "${{ inputs.annoy_ref }}" --depth=1 || true
          git checkout "${{ inputs.annoy_ref }}"
          git rev-parse --short HEAD

      - name: Ensure vendor output directory exists
        run: |
          mkdir -p "vendor/annoy/${{ inputs.output_version }}"

      - name: Build wheel only with uv (PEP 517)
        working-directory: annoy-src
        run: |
          # Build only the wheel for the selected Python, no sdist
          uv build --wheel \
          --python ${{ matrix.python-version }} \
          --out-dir "../vendor/annoy/${{ inputs.output_version }}"
          ls -l "../vendor/annoy/${{ inputs.output_version }}"
    
      - name: Upload wheel as artifact
        uses: actions/upload-artifact@v4
        with:
          name: annoy-wheels-${{ inputs.output_version }}-py${{ matrix.python-version }}
          path: vendor/annoy/${{ inputs.output_version }}/*.whl
          if-no-files-found: error


  commit-vendor:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout (full history, keep credentials)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: annoy-wheels-${{ inputs.output_version }}-py*
          path: _downloaded_wheels
          merge-multiple: true

      - name: Stage wheels into repo vendor tree
        run: |
          mkdir -p "vendor/annoy/${{ inputs.output_version }}"
          cp -v _downloaded_wheels/*.whl "vendor/annoy/${{ inputs.output_version }}/"
          ls -l "vendor/annoy/${{ inputs.output_version }}"

      - name: Commit changes (if any)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          BRANCH="vendor-annoy/${{ inputs.output_version }}"
          git checkout -b "$BRANCH" || git checkout "$BRANCH"

          git add vendor/annoy/${{ inputs.output_version }}/
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "vendor: add Annoy wheels for ${{ inputs.output_version }}"
          git push -u origin "$BRANCH"

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: vendor-annoy/${{ inputs.output_version }}
          title: "Vendor: Annoy wheels for ${{ inputs.output_version }}"
          body: |
            Adds Annoy wheels built by matrix (Py310â€“Py313) into `vendor/annoy/${{ inputs.output_version }}`.
          commit-message: "vendor: add Annoy wheels for ${{ inputs.output_version }}"
          base: ${{ github.ref_name }} # current branch as the PR target
