# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/14_to-emb-atlas.ipynb.

# %% auto 0
__all__ = ['relative_image_path', 'resize_for_preview', 'load_images', 'unzip_atlas', 'run_emb_atlas', 'create_emb_atlas']

# %% ../../nbs/14_to-emb-atlas.ipynb 2
import atexit
import zipfile
from pathlib import Path
from tempfile import TemporaryDirectory as TmpDir
from typing import Literal

import daft
import embedding_atlas.cli as emb_atlas_cli
import polars as pl
from daft.functions import to_struct
from PIL import Image

from .images import resize_to_max_side
from .utils import timestamp


# %% ../../nbs/14_to-emb-atlas.ipynb 6
@daft.func
def relative_image_path(img_path: str, viewer_dir: Path) -> str:
    return str(Path(img_path).relative_to(viewer_dir))

# %% ../../nbs/14_to-emb-atlas.ipynb 7
@daft.func
def resize_for_preview(image: Image.Image, max_side: int = 128) -> Image.Image:
    return resize_to_max_side(image, max_side)

# %% ../../nbs/14_to-emb-atlas.ipynb 8
def load_images(df: daft.DataFrame, image_path_col: str,
                viewer_dir: Path, mode: Literal["RGB", "RGBA", "L"],
                preview_size: int = 128) -> daft.DataFrame:
    originals_dir = viewer_dir / "jpg_originals"
    originals_dir.mkdir(exist_ok=True, parents=True)
    df = (df
    .with_column("image_bytes", daft.col(image_path_col).url.download(on_error="null"))
    .with_column("image", daft.col("image_bytes").image.decode())
    )
    if mode != "RGB": # loads as RGB by default
        df = df.with_column("image", daft.functions.convert_image(df["image"], mode=mode))

    df = (df
    .with_column("image_name", daft.col(image_path_col).str.replace("\\", "/").str.split("/"))
    .with_column("image_name", daft.col("image_name").get(-1))
    )

    df = (df
    .with_column("outpath", daft.functions.concat(
        daft.lit(str(originals_dir)+"/"), df["image_name"]
        ))
    .with_column("image_relpath", daft.functions.concat(
        daft.lit(originals_dir.name +"/"), df["image_name"]
        ))
    )

    # TODO: put None in for duplicate image names
    # and handle appropriate in upload (don't upload to orig folder, which is flat)
    daft.functions.upload(df["image"], df["outpath"])

    df = (df
    .with_column("image", resize_for_preview(df["image"], preview_size))
    .with_column("image_jpeg_bytes", daft.col("image").image.encode("JPEG"))
    .with_column("image_jpeg_base64", daft.col("image_jpeg_bytes").encode("base64").decode("utf-8"))
    # .with_column("image_relpath", relative_image_path(df[image_path_col], viewer_dir))
    )
    df = df.with_column("image_data_url",
                        daft.functions.concat(daft.lit("data:image/jpeg;base64,"),
                        df["image_jpeg_base64"]))
    df = df.with_column("image", to_struct(bytes=df["image_data_url"], path=df[image_path_col])
    ).exclude("image_bytes", "image_jpeg_bytes", "image_jpeg_base64", "image_data_url")

    front_cols = ["image", image_path_col]
    # drop_cols = ["image_bytes", "image_jpeg_bytes", "image_jpeg_base64"]
    others = sorted(c for c in df.column_names if c not in front_cols)
    keep = front_cols + others
    print(f"Columns to keep: {keep}")
    return df.select(*keep)

# %% ../../nbs/14_to-emb-atlas.ipynb 9
def unzip_atlas(zip_path: Path, extract_target: Path, delete_after: bool = False):
    """unzip at exit"""
    print(timestamp(), f"Extracting the viewer bundle to \n{extract_target.as_posix()}")
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_target)
    if delete_after:
        zip_path.unlink()
    return None

# %% ../../nbs/14_to-emb-atlas.ipynb 10
def run_emb_atlas(parquet_path: Path, zip_path: Path,
                  viewer_dir: Path, temp_dir: TmpDir):
    atexit.register(print,
                    f"{timestamp()} Finished creating atlas viewer at {viewer_dir}")
    atexit.register(temp_dir.cleanup)
    # last registered runs first
    atexit.register(unzip_atlas,
                    zip_path=zip_path, extract_target=viewer_dir
                    )
    emb_atlas_cli.main.main(
        args=[parquet_path.as_posix(),
            "--x", "emb_x", "--y", "emb_y",
            "--export-application", zip_path.as_posix(),
            ],
        standalone_mode=False
        )
    return None

# %% ../../nbs/14_to-emb-atlas.ipynb 11
def create_emb_atlas(table: pl.DataFrame, image_path_col: str,
                     viewer_dir: Path, plot_id: str,
                     mode: Literal["RGB", "RGBA", "L"] = "RGB",
                     preview_size: int = 128) -> None:
    df = daft.from_arrow(table.to_arrow())
    df = load_images(df, image_path_col, viewer_dir, mode, preview_size)
    prep_dir = TmpDir()
    parquet_path = Path(prep_dir.name) / f"viewer-input-{plot_id}.parquet"
    zip_path = parquet_path.with_suffix(".zip")
    df.write_parquet(parquet_path, write_mode="overwrite")
    run_emb_atlas(parquet_path, zip_path=zip_path,
                    viewer_dir=viewer_dir, temp_dir=prep_dir)
    return None
